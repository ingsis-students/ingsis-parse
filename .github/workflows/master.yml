name: Master Workflow
run-name: Continuous Integration

on:
  push:
    branches:
      - main
      - production

env:
  GITHUB_TOKEN: ${{ secrets.PAT }}
  GITHUB_ACTOR: ${{ github.actor }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.ref_name == main && 'tomasvalleduran/ingsis-parse' || 'tomasvalleduran/ingsis-parse-prod' }}
  VM_HOST: ${{ github.ref_name == main && '20.70.208.179' || '20.213.8.120' }}
  VM_USER: ${{ github.ref_name == main && 'students' || 'matichialva' }}


jobs:
  continuous integration:
    runs-on: ubuntu-latest

    steps:
      - name: continuous integration
        uses: ./.github/actions/cont-int.yml
        with:
          env_vars: ${{ toJson(env) }}

  continuous deployment:
    runs-on: ubuntu-latest
    needs: continuous integration

    steps:
      - name: continuous deployment
        uses: ./.github/actions/cont-dep.yml
        with:
          env_vars: ${{ toJson(env) }}

  continuous delivery:
    runs-on: ubuntu-latest
    needs: continuous deployment

    steps:
      - name: continuous delivery
        uses: ./.github/actions/cont-del.yml
        with:
          env_vars: ${{ toJson(env) }}

  update virtual machine:
    runs-on: ubuntu-latest
    needs: continuous delivery

    steps:
      - name: update vm
        uses: ./.github/actions/update-vm.yml
        with:
          env_vars: ${{ toJson(env) }}